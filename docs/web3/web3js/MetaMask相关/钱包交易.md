# 钱包交易

预先安装 Chrome 插件【metamask】，设置里打开测试环境。  
安装完成后，`window.ethereum`能直接访问到钱包实例，

`typescript`兼容：

```js
declare let window: any;
```

## 连接钱包，并检查是否锁定

```js
async function loginMetaMask() {
  // 校验是否有安装metamask插件
  if (typeof window.ethereum === "undefined" || !window.ethereum) {
    alert("The lack of MetaMask");
    return Promise.reject();
  }
  // 获取小狐狸账号，返回 [AccountAddress]
  const accounts = await window.ethereum.request({
    method: "eth_requestAccounts",
  });
  const account = accounts[0];
  // 判断账号是否锁定
  const isUnlocked = await window.ethereum._metamask.isUnlocked();
  return { account, isUnlocked };
}
```

## 直接钱包交易

```js
const txHash = await ethereum.request({
  method: 'eth_sendTransaction',
  params: [
    {
      from: ethereum.selectedAddress, // 当前的用户钱包
      to: '0x0000000000000000000000000000000000000000', // 转账目标地址
      value: '0x0', // 转账数量，单位为该币种最小单位（如ETH中的wei），16进制
    },
  ],
})
```

## 调用合约

```js
// 1. 获取1gas值
// 返回的的gasPrice需要乘一定的倍数保证大于最小的消耗量
const RATE = 1.2;
let gasPrice = (await web3.eth.getGasPrice()) * RATE;

// 2. 连接合约Contract
// abiList和fromAddres是合约的标识
const myContract = new web3.eth.Contract(abiList, fromAddress, {
  from: account, // 钱包账号地址
  gasPrice: parseInt(gasPrice), // gas量
});

// 3. 调用合约方法
myContract.methods.methodName().send().on('event', event => {} )
```
